# Creating Cluster
Step 1: Create Your Own Personal Cluster

In this guide, we'll demonstrate how to get started by creating a Kubernetes cluster on Ubuntu 18.04. We will be using kubeadm to set up kubernetes. We will then deploy the Weaveworks Socks Shop Microservices Application as a demonstration of how to run microservices on Kubernetes.

The purpose of this tutorial is to enable you to run a demo microservices application on a kubernetes cluster you have created.
Prerequisites

Before you begin this tutorial, you’ll need the following:

3 Ubuntu 18.04 servers with 4GM RAM and private networking enabled

We have already provisioned the servers for you where you can access by clicking on the tabs in the upper left corner {Control Plane, kube-02, kube-03}
Step 1 - Set up each server in the cluster to run Kubernetes.

On each of the three Ubuntu 18.04 servers run the following commands as root, you can type the commands or highlight and copy/paste in the terminal window on the left:

    Download the Google Cloud public signing key:

curl -fsSLo /usr/share/keyrings/kubernetes-archive-keyring.gpg https://packages.cloud.google.com/apt/doc/apt-key.gpg

    Add the Kubernetes apt repository:

echo "deb [signed-by=/usr/share/keyrings/kubernetes-archive-keyring.gpg] https://apt.kubernetes.io/ kubernetes-xenial main" | sudo tee /etc/apt/sources.list.d/kubernetes.list

    Update apt package index with the new repository and install the utilities:

apt update
apt install -y kubelet kubeadm kubectl docker.io
apt-mark hold kubelet kubeadm kubectl

    Kubelet: The primary agent that runs on a kubernetes node and communicates with the control plane to issue commands to this node and report status
    Kubeadm: A tool that performs the actions necessary to build up a Kubernetes cluster
    Kubectl: The command line tool that lets you control Kubernetes clusters and issue commands to the api-server
    Docker Engine: A container engine used by Kubernetes to run containers

Once completed, click on the Check button to continue ...

#### Setup the Kubernetes Control Plane
Step 2: Setup the Kubernetes Control Plane

Next, we are going to configure the Docker daemon to use systemd for the management of the container’s cgroups, copy the following block and paste it in the terminal window of each node {Control Plane, kube-02, kube-03}:

mkdir /etc/docker
cat <<EOF | sudo tee /etc/docker/daemon.json
{
"exec-opts": ["native.cgroupdriver=systemd"],
"log-driver": "json-file",
"log-opts": {
"max-size": "100m"
},
"storage-driver": "overlay2"
}
EOF

systemctl enable docker
systemctl daemon-reload
systemctl restart docker

On the Control Plane node only, run this command in order to initialize the Kubernetes control plane:

kubeadm init --ignore-preflight-errors=all

This can take a minute or two to run.

Before we begin using the cluster, we need to configure the kubectl command line tool that let us control the cluster. For configuration, kubectl looks for a file named config in the $HOME/.kube directory.

    Create the directory:

mkdir -p $HOME/.kube

    Copy the config file generated by kubeadm to $HOME/.kube/:

cp -i /etc/kubernetes/admin.conf $HOME/.kube/config

    Change ownership of the file to the current logged in user:

chown $(id -u):$(id -g) $HOME/.kube/config

Your Kubernetes Control Plane has initialized successfully!

#### Join your nodes to your Kubernetes cluster


### Setup a Kubernetes Add-On For Networking
Kubernetes Add-Ons are pods and services that implement cluster features. Pods extend the functionality of Kubernetes. You can install addons for a range of cluster features including Networking and Visualization.

We are going to install the Weave Net Add-On on the kube-01 Control Plane, which provides networking and network policy, will carry on work on both sides of a network partition, and does not require an external database. Read more about the Weave Net Add-on in the Weave Works Docs.

Weave-net is a CNI plugin which provides a virtual network that connects docker containers across multiple hosts.

By default Kubernetes comes with a simple network plugin that does not have the overlay networking capabilities.

Next you will deploy a pod network to the cluster.

The options are listed at: https://kubernetes.io/docs/concepts/cluster-administration/addons/
Installing the Weave Net Add-On

On the Control Plane node, run the kubectl apply command which will create all the networking resources in the cluster from the supplied manifest file:

kubectl apply -f "https://cloud.weave.works/k8s/net?k8s-version=$(kubectl version | base64 | tr -d '\n')"

The result will look like this:

serviceaccount "weave-net" created
clusterrole "weave-net" created
clusterrolebinding "weave-net" created
role "weave-net" created
rolebinding "weave-net" created
daemonset "weave-net" created

It may take a minute or two for DNS to be ready, continue to check for DNS to be ready before moving on by running the kubectl get command which allow us to display the resources and prints a table of the most important information about the specified resources:

watch kubectl get pods --all-namespaces
CTRL+C to exit

The successful result will look like this, every container should be running:

NAMESPACE     NAME                              READY     STATUS    RESTARTS   AGE
kube-system   etcd-kube-01                      1/1       Running   0          5m
kube-system   kube-apiserver-kube-01            1/1       Running   0          6m
kube-system   kube-controller-manager-kube-01   1/1       Running   0          5m
kube-system   kube-dns-6f4fd4bdf-whbhd          3/3       Running   0          6m
kube-system   kube-proxy-2hdhk                  1/1       Running   0          6m
kube-system   kube-proxy-tvhjk                  1/1       Running   0          5m
kube-system   kube-proxy-wspmv                  1/1       Running   0          5m
kube-system   kube-scheduler-kube-01            1/1       Running   0          6m
kube-system   weave-net-9ghn5                   2/2       Running   1          5m
kube-system   weave-net-lh8tq                   2/2       Running   0          5m
kube-system   weave-net-qhr25                   2/2       Running   0          5m

Check the nodes status again:

kubectl get nodes

NAME      STATUS    ROLES     AGE       VERSION
kube-01   Ready     Control Plane    8m        v1.x.x
kube-02   Ready     <none>    6m        v1.x.x
kube-03   Ready     <none>    6m        v1.x.x

Congratulations, now your Kubernetes cluster running on Ubuntu 18.04 is up and ready for you to deploy a microservices application!!

#### Deploying The Microservices Sock Shop
Next we will deploy a demo microservices application to your kubernetes cluster.

First, on Control Plane, clone the microservices sock shop git repo:

git clone https://github.com/microservices-demo/microservices-demo.git

Go to the microservices-demo/deploy/kubernetes folder:

cd microservices-demo/deploy/kubernetes

Next apply the demo to your kubernetes cluster:

kubectl apply -f complete-demo.yaml

You will see the following result

deployment "carts-db" created
service "carts-db" created
deployment "carts" created
service "carts" created
deployment "catalogue-db" created
service "catalogue-db" created
deployment "catalogue" created
service "catalogue" created
deployment "front-end" created
service "front-end" created
deployment "orders-db" created
service "orders-db" created
deployment "orders" created
service "orders" created
deployment "payment" created
service "payment" created
deployment "queue-Control Plane" created
service "queue-Control Plane" created
deployment "rabbitmq" created
service "rabbitmq" created
deployment "shipping" created
service "shipping" created
deployment "user-db" created
service "user-db" created
deployment "user" created
service "user" created

Check to see if all of your pods are running:

watch kubectl get pods --namespace sock-shop
CTRL+C to exit

You will see the following result when all pods are ready, they will have the status of “Running”:

NAMESPACE     NAME                              READY     STATUS    RESTARTS   AGE
sock-shop     carts-74f4558cb8-h9924            1/1       Running   0          11m
sock-shop     carts-db-7fcddfbc79-v64fw         1/1       Running   0          11m
sock-shop     catalogue-676d4b9f7c-55n4g        1/1       Running   0          11m
sock-shop     catalogue-db-5c67cdc8cd-hvk96     1/1       Running   0          11m
sock-shop     front-end-977bfd86-hq9x9          1/1       Running   0          11m
sock-shop     orders-787bf5b89f-xfdl6           1/1       Running   0          11m
sock-shop     orders-db-775655b675-gv456        1/1       Running   0          11m
sock-shop     payment-75f75b467f-4zzqs          1/1       Running   0          11m
sock-shop     queue-Control Plane-5c86964795-t8sjg     1/1       Running   0          11m
sock-shop     rabbitmq-96d887875-lf46w          1/1       Running   0          11m
sock-shop     shipping-5bd69fb4cc-vprmp         1/1       Running   0          11m
sock-shop     user-5bd9b9c468-4rms8             1/1       Running   0          11m
sock-shop     user-db-5f9d89bbbb-r69pd          1/1       Running   0          11m

Visit the Sock Shop application by clicking on the tab with the designated name in the upper left.

Congratulations! You have successfully completed the lab : )
Conclusion

You have created a Kubernetes cluster and learned how to use the Kubernetes command-line tool kubectl. You then deployed Weave Socks Shop Microservices Application as a demonstration of how to run microservices on Kubernetes. You have now started to see how Kubernetes is designed to manage applications built within containers across clustered environments.